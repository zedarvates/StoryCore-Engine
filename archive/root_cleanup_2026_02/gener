#!/usr/bin/env python3
"""
StoryCore Base Asset Generator using FLUX 2 Workflow
Simplified text-to-image workflow (no input image required)
"""

import asyncio
import aiohttp
import time
import json
from pathlib import Path

COMFYUI_URL = 'http://127.0.0.1:8000'
OUTPUT_DIR = Path('assets/generated')

ASSETS = [
    ('storycore_logo_horizontal', 'Professional logo design for StoryCore text, modern typography, clean minimal style', 1024, 256),
    ('storycore_logo_square', 'Square app icon design SC monogram logo, modern minimal style', 512, 512),
    ('storycore_panel_placeholder', 'Storyboard panel placeholder, neutral gray gradient background, subtle grid', 768, 432),
    ('storycore_loading_state', 'Loading spinner icon, clean minimal UI design', 256, 256),
    ('storycore_error_state', 'Warning triangle icon, clean UI error graphic', 400, 300),
    ('storycore_character_template', 'Character design template for storyboard, generic figure outline', 512, 768),
    ('storycore_banner_featured', 'Featured banner design, horizontal layout, dark gradient background', 1200, 400),
]


def create_flux2_workflow(name, prompt, width, height, seed=None):
    """Create FLUX 2 workflow - simplified text-to-image (no input image)"""
    if seed is None:
        seed = int(time.time()) % 1000000000000
    
    return {
        "68:25": {
            "inputs": {"noise_seed": seed},
            "class_type": "RandomNoise"
        },
        "68:47": {
            "inputs": {"width": width, "height": height, "batch_size": 1},
            "class_type": "EmptyFlux2LatentImage"
        },
        "68:48": {
            "inputs": {"steps": 20, "width": width, "height": height},
            "class_type": "Flux2Scheduler"
        },
        "68:38": {
            "inputs": {"clip_name": "mistral_3_small_flux2_bf16.safetensors", "type": "flux2", "device": "default"},
            "class_type": "CLIPLoader"
        },
        "68:6": {
            "inputs": {"text": prompt, "clip": ["68:38", 0]},
            "class_type": "CLIPTextEncode"
        },
        "68:26": {
            "inputs": {"guidance": 4, "conditioning": ["68:6", 0]},
            "class_type": "FluxGuidance"
        },
        "68:22": {
            "inputs": {"model": ["68:12", 0], "conditioning": ["68:26", 0]},
            "class_type": "BasicGuider"
        },
        "68:12": {
            "inputs": {"unet_name": "flux2_dev_fp8mixed.safetensors", "weight_dtype": "default"},
            "class_type": "UNETLoader"
        },
        "68:10": {
            "inputs": {"vae_name": "flux2-vae.safetensors"},
            "class_type": "VAELoader"
        },
        "68:16": {
            "inputs": {"sampler_name": "euler"},
            "class_type": "KSamplerSelect"
        },
        "68:13": {
            "inputs": {
                "noise": ["68:25", 0],
                "guider": ["68:22", 0],
                "sampler": ["68:16", 0],
                "sigmas": ["68:48", 0],
                "latent_image": ["68:47", 0]
            },
            "class_type": "SamplerCustomAdvanced"
        },
        "68:8": {
            "inputs": {"samples": ["68:13", 0], "vae": ["68:10", 0]},
            "class_type": "VAEDecode"
        },
        "9": {
            "inputs": {"filename_prefix": f"StoryCore_{name}", "images": ["68:8", 0]},
            "class_type": "SaveImage"
        }
    }


async def queue_prompt(session, workflow):
    payload = {'prompt': workflow, 'client_id': f'storycore_{int(time.time())}'}
    async with session.post(f'{COMFYUI_URL}/prompt', json=payload) as r:
        if r.status == 200:
            return await r.json()
        raise Exception(f'Queue failed: {r.status}')


async def wait_done(session, prompt_id):
    for _ in range(300):
        await asyncio.sleep(1)
        async with session.get(f'{COMFYUI_URL}/history/{prompt_id}') as r:
            if r.status == 200:
                h = await r.json()
                if prompt_id in h:
                    s = h[prompt_id].get('status', {})
                    if s.get('completed'):
                        return True
                    if s.get('exception'):
                        raise Exception(s['exception'])
    raise Exception('Timeout')


async def download(session, prompt_id, path):
    async with session.get(f'{COMFYUI_URL}/history/{prompt_id}') as r:
        if r.status != 200:
            return False
        h = await r.json()
        if prompt_id in h:
            for n, o in h[prompt_id].get('outputs', {}).items():
                if 'images' in o:
                    for img in o['images']:
                        p = {'filename': img['filename'], 'type': img['type']}
                        if img.get('subfolder'):
                            p['subfolder'] = img['subfolder']
                        async with session.get(f'{COMFYUI_URL}/view', params=p) as r:
                            if r.status == 200:
                                path.parent.mkdir(parents=True, exist_ok=True)
                                path.write_bytes(await r.read())
                                return True
    return False


async def generate(session, name, prompt, w, h):
    print(f'Generating: {name}...')
    try:
        wf = create_flux2_workflow(name, prompt, w, h)
        result = await queue_prompt(session, wf)
        pid = result.get('prompt_id')
        print(f'  Queued: {pid}')
        await wait_done(session, pid)
        p = OUTPUT_DIR / (f'{name}.png')
        if await download(session, pid, p):
            print(f'  Saved: {p}')
            return True
        print('  Download failed')
        return False
    except Exception as e:
        print(f'  Error: {str(e)[:100]}')
        return False


async def main():
    print('=' * 60)
    print('StoryCore FLUX 2 Asset Generator')
    print('=' * 60)
    
    async with aiohttp.ClientSession() as session:
        print('')
        print('Checking ComfyUI...')
        r = await session.get(f'{COMFYUI_URL}/')
        if r.status != 200:
            print('ComfyUI not accessible!')
            return
        print('Connected!')
        
        print('')
        print(f'Generating {len(ASSETS)} assets...')
        results = []
        for name, prompt, w, h in ASSETS:
            ok = await generate(session, name, prompt, w, h)
            results.append((name, ok))
            await asyncio.sleep(2)
        
        print('')
        print('=' * 60)
        print('Summary:')
        for n, ok in results:
            status = 'OK' if ok else 'FAILED'
            print(f'  {n}: {status}')
        print('=' * 60)


asyncio.run(main())
