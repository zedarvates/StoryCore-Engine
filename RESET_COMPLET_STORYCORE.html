<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Complet StoryCore - Correction Endpoint Ollama</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        .subtitle {
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.2em;
            opacity: 0.9;
        }
        .button {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 15px 0;
            font-size: 1.1em;
            font-weight: bold;
            color: white;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        .button.success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .button.danger {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        .button.warning {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            color: #2d3436;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
            display: none;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .status.show {
            display: block;
        }
        .status.success {
            background: rgba(76, 175, 80, 0.3);
        }
        .status.error {
            background: rgba(244, 67, 54, 0.3);
        }
        .info {
            background: rgba(255, 255, 255, 0.15);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .info h3 {
            margin-top: 0;
        }
        .info ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .info li {
            margin: 5px 0;
        }
        code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
        .alert {
            background: rgba(255, 193, 7, 0.3);
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .alert h4 {
            margin-top: 0;
        }
        .step {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
        }
        .step h4 {
            margin-top: 0;
            color: #4facfe;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Reset Complet StoryCore</h1>
        <div class="subtitle">Correction Endpoint Ollama: /api/chat ‚Üí /api/generate</div>
        
        <div class="alert">
            <h4>‚ö†Ô∏è Probl√®me Identifi√©</h4>
            <p>Le code utilise le mauvais endpoint Ollama:</p>
            <ul>
                <li>‚ùå <code>/api/chat</code> (n'existe pas) ‚Üí Erreur 404</li>
                <li>‚úÖ <code>/api/generate</code> (correct)</li>
            </ul>
            <p><strong>Solution:</strong> Nettoyer le cache et recharger l'application</p>
        </div>

        <div class="info">
            <h3>üìã Ce que cet outil va faire:</h3>
            <ul>
                <li>Supprimer toutes les anciennes configurations LLM</li>
                <li>Nettoyer le cache du navigateur</li>
                <li>R√©initialiser localStorage</li>
                <li>Forcer le rechargement du code corrig√©</li>
            </ul>
        </div>

        <div class="step">
            <h4>√âtape 1: V√©rifier l'√âtat Actuel</h4>
            <button class="button success" onclick="checkStatus()">
                ‚úÖ V√©rifier l'√âtat
            </button>
        </div>

        <div class="step">
            <h4>√âtape 2: Nettoyer les Configurations</h4>
            <button class="button" onclick="clearLLMConfig()">
                üóëÔ∏è Supprimer Configuration LLM
            </button>
        </div>

        <div class="step">
            <h4>√âtape 3: Nettoyer Tout</h4>
            <button class="button warning" onclick="clearAllStorage()">
                üßπ Nettoyer Tout le localStorage
            </button>
        </div>

        <div class="step">
            <h4>√âtape 4: Reset Complet</h4>
            <button class="button danger" onclick="resetAndReload()">
                üîÑ Reset Complet + Hard Reload
            </button>
        </div>

        <div class="step">
            <h4>√âtape 5: Tester Ollama</h4>
            <button class="button success" onclick="testOllama()">
                üß™ Tester Connexion Ollama
            </button>
        </div>

        <div id="status" class="status"></div>

        <div class="info">
            <h3>‚ö†Ô∏è Apr√®s le reset:</h3>
            <ol>
                <li>Red√©marrer le serveur de dev:
                    <br><code>cd creative-studio-ui && npm run dev</code>
                </li>
                <li>Ouvrir <code>http://localhost:5173</code></li>
                <li>Faire un Hard Refresh: <code>Ctrl+Shift+R</code></li>
                <li>Ouvrir Settings ‚Üí LLM Configuration</li>
                <li>S√©lectionner "Local LLM"</li>
                <li>Endpoint: <code>http://localhost:11434</code></li>
                <li>Choisir un mod√®le (ex: llama3.1:8b)</li>
                <li>Tester la connexion ‚úÖ</li>
                <li>Sauvegarder</li>
            </ol>
        </div>

        <div class="info">
            <h3>üîç V√©rification que √ßa fonctionne:</h3>
            <ul>
                <li>Ouvrir DevTools (F12) ‚Üí Network</li>
                <li>Envoyer un message dans le chatbox</li>
                <li>V√©rifier que la requ√™te va vers: <code>http://localhost:11434/api/generate</code></li>
                <li>Si c'est encore <code>/api/chat</code>, refaire le reset</li>
            </ul>
        </div>
    </div>

    <script>
        function showStatus(message, isSuccess = true) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status show ' + (isSuccess ? 'success' : 'error');
        }

        function clearLLMConfig() {
            try {
                const keys = [
                    'storycore_llm_config',
                    'storycore_api_key_enc',
                    'storycore-settings',
                    'llm-config'
                ];
                
                let removed = 0;
                keys.forEach(key => {
                    if (localStorage.getItem(key)) {
                        localStorage.removeItem(key);
                        removed++;
                    }
                });
                
                showStatus(`‚úÖ Configuration LLM supprim√©e!\n${removed} cl√©s supprim√©es:\n${keys.join('\n')}`, true);
            } catch (error) {
                showStatus('‚ùå Erreur: ' + error.message, false);
            }
        }

        function clearAllStorage() {
            try {
                const count = localStorage.length;
                const keys = [];
                for (let i = 0; i < count; i++) {
                    keys.push(localStorage.key(i));
                }
                
                localStorage.clear();
                showStatus(`‚úÖ ${count} √©l√©ments supprim√©s du localStorage!\n\nCl√©s supprim√©es:\n${keys.join('\n')}`, true);
            } catch (error) {
                showStatus('‚ùå Erreur: ' + error.message, false);
            }
        }

        function checkStatus() {
            const items = {
                'storycore_llm_config': localStorage.getItem('storycore_llm_config'),
                'storycore_api_key_enc': localStorage.getItem('storycore_api_key_enc'),
                'storycore-settings': localStorage.getItem('storycore-settings'),
                'llm-config': localStorage.getItem('llm-config')
            };

            let message = 'üìä √âtat actuel du localStorage:\n\n';
            let hasData = false;

            for (const [key, value] of Object.entries(items)) {
                if (value) {
                    message += `‚ùå ${key}: PR√âSENT (${value.length} caract√®res)\n`;
                    hasData = true;
                } else {
                    message += `‚úÖ ${key}: VIDE\n`;
                }
            }

            message += `\nTotal localStorage: ${localStorage.length} cl√©s\n`;

            if (!hasData) {
                message += '\n‚ú® Toutes les configurations LLM sont propres!';
            } else {
                message += '\n‚ö†Ô∏è Certaines configurations sont encore pr√©sentes';
                message += '\n\nüí° Cliquez sur "Supprimer Configuration LLM" pour nettoyer';
            }

            showStatus(message, !hasData);
        }

        async function testOllama() {
            showStatus('üîÑ Test de connexion √† Ollama...', true);
            
            try {
                // Test 1: V√©rifier que Ollama est accessible
                const response1 = await fetch('http://localhost:11434/api/tags');
                if (!response1.ok) {
                    throw new Error(`Ollama non accessible (${response1.status})`);
                }
                
                const data = await response1.json();
                const models = data.models || [];
                
                let message = '‚úÖ Ollama est accessible!\n\n';
                message += `üì¶ Mod√®les disponibles (${models.length}):\n`;
                models.forEach(model => {
                    message += `  ‚Ä¢ ${model.name}\n`;
                });
                
                // Test 2: Tester l'endpoint /api/generate
                message += '\nüß™ Test de l\'endpoint /api/generate...\n';
                
                if (models.length > 0) {
                    const testModel = models[0].name;
                    const response2 = await fetch('http://localhost:11434/api/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: testModel,
                            prompt: 'Test',
                            stream: false
                        })
                    });
                    
                    if (response2.ok) {
                        const result = await response2.json();
                        message += `‚úÖ Endpoint /api/generate fonctionne!\n`;
                        message += `   Mod√®le test√©: ${testModel}\n`;
                        message += `   R√©ponse re√ßue: ${result.response ? 'OUI' : 'NON'}\n`;
                    } else {
                        message += `‚ùå Endpoint /api/generate erreur ${response2.status}\n`;
                    }
                } else {
                    message += '‚ö†Ô∏è Aucun mod√®le install√© pour tester\n';
                    message += '\nüí° Installez un mod√®le avec:\n';
                    message += '   ollama pull llama3.1:8b\n';
                }
                
                showStatus(message, true);
            } catch (error) {
                let message = '‚ùå Erreur de connexion √† Ollama:\n\n';
                message += error.message + '\n\n';
                message += 'üîß V√©rifications:\n';
                message += '  1. Ollama est-il lanc√©?\n';
                message += '  2. Port 11434 accessible?\n';
                message += '  3. Firewall bloque-t-il?\n\n';
                message += 'üí° Commandes utiles:\n';
                message += '  ‚Ä¢ V√©rifier: curl http://localhost:11434/api/tags\n';
                message += '  ‚Ä¢ Lister: ollama list\n';
                message += '  ‚Ä¢ Installer: ollama pull llama3.1:8b\n';
                showStatus(message, false);
            }
        }

        function resetAndReload() {
            if (confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir tout r√©initialiser et recharger la page?\n\nCela va:\n1. Supprimer tout le localStorage\n2. Vider le cache\n3. Recharger la page (hard refresh)')) {
                try {
                    // Supprimer localStorage
                    localStorage.clear();
                    
                    // Supprimer sessionStorage aussi
                    sessionStorage.clear();
                    
                    showStatus('‚úÖ Reset complet effectu√©!\n\nüîÑ Rechargement avec cache vid√©...', true);
                    
                    setTimeout(() => {
                        // Hard reload avec cache vid√©
                        window.location.reload(true);
                    }, 1500);
                } catch (error) {
                    showStatus('‚ùå Erreur: ' + error.message, false);
                }
            }
        }

        // V√©rifier l'√©tat au chargement
        window.onload = function() {
            checkStatus();
            
            // Afficher un message d'aide
            setTimeout(() => {
                if (localStorage.length > 0) {
                    showStatus('üí° Conseil: Commencez par "V√©rifier l\'√âtat" pour voir ce qui doit √™tre nettoy√©', true);
                }
            }, 1000);
        };
    </script>
</body>
</html>
