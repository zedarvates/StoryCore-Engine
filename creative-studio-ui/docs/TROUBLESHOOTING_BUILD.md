# Build Configuration Troubleshooting Guide

Quick solutions for common build configuration issues.

## Table of Contents

1. [Quick Diagnostics](#quick-diagnostics)
2. [Module Resolution Errors](#module-resolution-errors)
3. [TypeScript Configuration Issues](#typescript-configuration-issues)
4. [Git and Version Control](#git-and-version-control)
5. [Development Server Issues](#development-server-issues)
6. [Build Failures](#build-failures)
7. [Performance Issues](#performance-issues)
8. [Advanced Debugging](#advanced-debugging)

---

## Quick Diagnostics

### Run These First

```bash
# 1. Check for configuration issues
npm run validate

# 2. Clean source directory
npm run clean

# 3. Try development again
npm run dev
```

**If that doesn't work, continue reading...**

---

## Module Resolution Errors

### Error: Cannot find module './undoRedo'

**Symptoms:**
```
Error: Cannot find module './undoRedo'
    at Module._resolveFilename (internal/modules/cjs/loader.js:...)
```

**Cause:** Stray `.js` file conflicting with `.ts` file.

**Solution:**
```bash
# Step 1: Clean source directory
npm run clean

# Step 2: Restart dev server
npm run dev
```

**Why it works:** Removes the conflicting `.js` file, allowing module resolution to find the correct `.ts` file.

---

### Error: exports is not defined

**Symptoms:**
```
ReferenceError: exports is not defined
    at undoRedo.js:1:1
```

**Cause:** CommonJS `.js` file loaded in ESM context.

**Solution:**
```bash
# Step 1: Find the problematic file
npm run validate

# Step 2: Remove it
npm run clean

# Step 3: Verify TypeScript config
cat tsconfig.app.json | grep noEmit
# Should show: "noEmit": true
```

**Why it works:** The `.js` file was generated by TypeScript with CommonJS format, but Vite expects ESM. Removing it forces Vite to use the `.ts` source.

---

### Error: require is not defined

**Symptoms:**
```
ReferenceError: require is not defined
    at logger.js:1:1
```

**Cause:** CommonJS syntax in ESM environment.

**Solution:**
```bash
# Step 1: Clean source directory
npm run clean

# Step 2: Check for more .js files
find src -name "*.js"

# Step 3: If found, clean again
npm run clean

# Step 4: Restart
npm run dev
```

**Prevention:**
```bash
# Add pre-commit hook
echo '#!/bin/sh\nnpm run validate' > .git/hooks/pre-commit
chmod +x .git/hooks/pre-commit
```

---

### Error: Unexpected token 'export'

**Symptoms:**
```
SyntaxError: Unexpected token 'export'
    at Module._compile (internal/modules/cjs/loader.js:...)
```

**Cause:** ESM syntax in CommonJS context (wrong file loaded).

**Solution:**
```bash
# Step 1: Validate configuration
npm run validate

# Step 2: Clean if issues found
npm run clean

# Step 3: Check module type in package.json
cat package.json | grep '"type"'
# Should show: "type": "module"
```

---

## TypeScript Configuration Issues

### TypeScript Generating .js Files

**Symptoms:**
- `.js` files appearing in `src/` after running `tsc`
- Validation reports `.js` files in source

**Diagnosis:**
```bash
# Check TypeScript configuration
npx tsc --showConfig | grep noEmit
```

**Solution:**
```bash
# Step 1: Update tsconfig.app.json
# Set "noEmit": true

# Step 2: Clean existing files
npm run clean

# Step 3: Verify
npm run validate
```

**Correct configuration:**
```json
{
  "compilerOptions": {
    "noEmit": true
  }
}
```

---

### Error: Cannot write file (EEXIST)

**Symptoms:**
```
Error: Cannot write file 'src/components/MyComponent.js'
Error: EEXIST: file already exists
```

**Cause:** TypeScript trying to overwrite existing file.

**Solution:**
```bash
# Step 1: Remove conflicting files
npm run clean

# Step 2: Check TypeScript config
npm run validate

# Step 3: Ensure noEmit is true
cat tsconfig.app.json | grep noEmit
```

---

### Error: outDir is not set

**Symptoms:**
```
Warning: outDir is not set
Files will be emitted to source directory
```

**Cause:** Missing or incorrect TypeScript configuration.

**Solution:**
```bash
# Option 1: Set noEmit (recommended)
# In tsconfig.app.json:
{
  "compilerOptions": {
    "noEmit": true
  }
}

# Option 2: Set outDir (alternative)
{
  "compilerOptions": {
    "outDir": "dist"
  }
}

# Verify
npm run validate
```

**Recommendation:** Use `noEmit: true` to prevent any `.js` generation.

---

## Git and Version Control

### Git Tracking .js Files in src/

**Symptoms:**
```bash
$ git status
modified:   src/components/undoRedo.js
modified:   src/services/wizard/logger.js
```

**Cause:** Missing `.gitignore` patterns.

**Solution:**
```bash
# Step 1: Add proper patterns
npm run validate -- --fix

# Step 2: Remove tracked files
git rm src/**/*.js

# Step 3: Commit changes
git commit -m "Remove compiled artifacts from source"

# Step 4: Verify
git status
```

**Correct .gitignore:**
```gitignore
# Compiled artifacts in source
src/**/*.js
src/**/*.js.map
src/**/*.d.ts

# Build outputs
dist/
dist-ssr/

# TypeScript build info
*.tsbuildinfo
```

---

### Error: .gitignore patterns not working

**Symptoms:**
- `.js` files still tracked by git
- `git add` includes `.js` files

**Diagnosis:**
```bash
# Check if files are already tracked
git ls-files src/**/*.js
```

**Solution:**
```bash
# Step 1: Remove from git tracking
git rm --cached src/**/*.js

# Step 2: Verify .gitignore
npm run validate

# Step 3: Add .gitignore patterns if missing
npm run validate -- --fix

# Step 4: Commit
git commit -m "Untrack compiled artifacts"
```

**Why it works:** Files already tracked by git are not affected by `.gitignore`. Must explicitly remove them.

---

## Development Server Issues

### HMR Not Working

**Symptoms:**
- Changes not reflected in browser
- Manual refresh required
- Console shows module errors

**Diagnosis:**
```bash
# Check for conflicts
npm run validate

# Check dev server logs
npm run dev
# Look for errors in output
```

**Solution:**
```bash
# Step 1: Clean source directory
npm run clean

# Step 2: Clear browser cache
# In browser: Ctrl+Shift+Delete

# Step 3: Restart dev server
npm run dev

# Step 4: Hard refresh browser
# Ctrl+Shift+R (Windows/Linux)
# Cmd+Shift+R (Mac)
```

---

### Dev Server Won't Start

**Symptoms:**
```
Error: Port 5173 is already in use
```

**Solution:**
```bash
# Option 1: Kill existing process
# Windows:
netstat -ano | findstr :5173
taskkill /PID <PID> /F

# Linux/Mac:
lsof -ti:5173 | xargs kill -9

# Option 2: Use different port
npm run dev -- --port 5174
```

---

### Dev Server Crashes on File Change

**Symptoms:**
- Server crashes when saving files
- Error: "ENOSPC: System limit for number of file watchers reached"

**Solution (Linux):**
```bash
# Increase file watcher limit
echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf
sudo sysctl -p
```

**Solution (Windows):**
```bash
# Restart dev server with polling
npm run dev -- --force
```

---

## Build Failures

### Build Fails with Type Errors

**Symptoms:**
```
Error: Type 'string' is not assignable to type 'number'
Build failed
```

**Solution:**
```bash
# Step 1: Run type checking only
npx tsc --noEmit

# Step 2: Fix type errors in source
# (Address each error reported)

# Step 3: Verify fixes
npx tsc --noEmit

# Step 4: Build again
npm run build
```

---

### Build Fails with "Cannot write file"

**Symptoms:**
```
Error: Cannot write file 'dist/assets/index.js'
Error: EACCES: permission denied
```

**Solution:**
```bash
# Step 1: Clean dist directory
npm run clean:dist

# Step 2: Check permissions
ls -la dist/

# Step 3: Fix permissions if needed
chmod -R 755 dist/

# Step 4: Build again
npm run build
```

---

### Build Succeeds but Validation Fails

**Symptoms:**
```
Build completed successfully
âœ— Validation failed: Found .js files in src/
```

**Cause:** TypeScript generated files during build.

**Solution:**
```bash
# Step 1: Check TypeScript configuration
npm run validate

# Step 2: Ensure noEmit is true
cat tsconfig.app.json | grep noEmit

# Step 3: Clean and rebuild
npm run clean
npm run build
```

---

## Performance Issues

### Cleanup Takes Too Long

**Symptoms:**
- `npm run clean` takes > 10 seconds
- Cleanup blocks development workflow

**Solution:**
```bash
# Option 1: Clean specific directory
node scripts/clean-build-artifacts.cjs --target-dir src/components

# Option 2: Use dry run to check
node scripts/clean-build-artifacts.cjs --dry-run

# Option 3: Exclude large directories
# Edit scripts/clean-build-artifacts.cjs:
excludeDirs: ['node_modules', 'dist', '.git', 'coverage']
```

---

### Validation Takes Too Long

**Symptoms:**
- `npm run validate` takes > 5 seconds
- Slows down development

**Solution:**
```bash
# Option 1: Skip validation in dev
# Remove from predev hook temporarily

# Option 2: Validate only before commits
# Use pre-commit hook instead

# Option 3: Validate specific checks
# Edit scripts/validate-build-config.cjs
# Comment out slow checks
```

---

### Build Takes Too Long

**Symptoms:**
- `npm run build` takes > 5 minutes
- CI/CD pipeline times out

**Solution:**
```bash
# Step 1: Analyze bundle size
npm run build -- --mode production

# Step 2: Check for large dependencies
npx vite-bundle-visualizer

# Step 3: Optimize Vite config
# In vite.config.ts:
export default defineConfig({
  build: {
    minify: 'esbuild',  // Faster than terser
    sourcemap: false,    // Disable in production
    rollupOptions: {
      output: {
        manualChunks: {
          vendor: ['react', 'react-dom']
        }
      }
    }
  }
});
```

---

## Advanced Debugging

### Enable Verbose Logging

```bash
# Verbose cleanup
node scripts/clean-build-artifacts.cjs --verbose

# Verbose validation
DEBUG=* npm run validate

# Vite debug mode
DEBUG=vite:* npm run dev

# TypeScript trace
npx tsc --traceResolution > trace.log
```

---

### Inspect TypeScript Configuration

```bash
# Show effective configuration
npx tsc --showConfig

# List all files being compiled
npx tsc --listFiles

# Explain why files are included
npx tsc --explainFiles
```

---

### Inspect Module Resolution

```bash
# Trace module resolution
npx tsc --traceResolution | grep "undoRedo"

# Check Vite resolution
npm run dev -- --debug

# Manual resolution test
node -e "console.log(require.resolve('./src/components/undoRedo'))"
```

---

### Check File System State

```bash
# Find all .js files in src/
find src -name "*.js"

# Count .js files
find src -name "*.js" | wc -l

# Show file details
ls -la src/**/*.js

# Check file timestamps
stat src/components/undoRedo.js
```

---

### Monitor Build Process

```bash
# Watch file changes
npm run dev -- --debug

# Monitor cleanup
node scripts/clean-build-artifacts.cjs --verbose

# Monitor validation
node scripts/validate-build-config.cjs --verbose

# Profile build
npm run build -- --profile
```

---

## Common Error Messages

### "Module not found"

**Quick fix:**
```bash
npm run clean && npm run dev
```

---

### "exports is not defined"

**Quick fix:**
```bash
npm run clean && npm run dev
```

---

### "require is not defined"

**Quick fix:**
```bash
npm run clean && npm run dev
```

---

### "Cannot write file"

**Quick fix:**
```bash
npm run clean && npm run validate
```

---

### "Validation failed"

**Quick fix:**
```bash
npm run validate -- --fix
```

---

## Preventive Measures

### Pre-commit Hook

```bash
# Install Husky
npm install --save-dev husky

# Initialize
npx husky install

# Add pre-commit hook
npx husky add .husky/pre-commit "npm run validate"
```

---

### CI/CD Validation

```yaml
# .github/workflows/ci.yml
- name: Validate build configuration
  run: npm run validate -- --ci

- name: Build
  run: npm run build

- name: Post-build validation
  run: npm run validate -- --ci
```

---

### Regular Maintenance

```bash
# Weekly cleanup
npm run clean
npm run clean:dist

# Monthly validation
npm run validate

# Update dependencies
npm update
npm audit fix
```

---

## Getting Help

### Before Asking for Help

1. **Run diagnostics:**
   ```bash
   npm run validate
   ```

2. **Check logs:**
   ```bash
   npm run dev -- --debug
   ```

3. **Search existing issues:**
   - GitHub issues
   - Stack Overflow
   - Project documentation

### When Creating an Issue

Include:

1. **Error message:**
   ```
   Full error output from terminal
   ```

2. **Validation output:**
   ```bash
   npm run validate
   ```

3. **TypeScript configuration:**
   ```bash
   cat tsconfig.app.json
   ```

4. **Environment:**
   - Node version: `node --version`
   - npm version: `npm --version`
   - OS: Windows/Mac/Linux

5. **Steps to reproduce:**
   1. Step 1
   2. Step 2
   3. Error occurs

---

## Quick Reference

### Most Common Issues

| Issue | Quick Fix |
|-------|-----------|
| Module not found | `npm run clean && npm run dev` |
| exports is not defined | `npm run clean && npm run dev` |
| require is not defined | `npm run clean && npm run dev` |
| TypeScript generating .js | Set `noEmit: true` in tsconfig |
| Git tracking .js files | `npm run validate -- --fix` |
| HMR not working | `npm run clean && npm run dev` |
| Build fails | `npm run clean && npm run build` |
| Validation fails | `npm run validate -- --fix` |

### Emergency Recovery

```bash
# Nuclear option: Clean everything and rebuild
rm -rf node_modules dist
npm install
npm run clean
npm run validate
npm run build
```

---

## Summary

**Remember the three-step process:**

1. **Clean:** `npm run clean`
2. **Validate:** `npm run validate`
3. **Retry:** `npm run dev` or `npm run build`

**Most issues are caused by:**
- Stray `.js` files in `src/`
- Incorrect TypeScript configuration
- Missing `.gitignore` patterns

**Prevention is key:**
- Use pre-commit hooks
- Validate regularly
- Keep configuration consistent

For detailed information, see [BUILD_CONFIGURATION.md](BUILD_CONFIGURATION.md).
